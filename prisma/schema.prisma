generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CUSTOMER
  VENDOR
  ADMIN
}

model Category {
  id   Int    @id @default(autoincrement())
  name String @unique

  products Product[]
}

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String
  name     String
  address  String?
  role     Role    @default(CUSTOMER)

  // details needs for vendor registration
  companyName String?
  gstin       String? // Mandatory for invoicing logic

  // Relations
  products Product[] // Only for Vendors
  orders   Order[]
  invoices Invoice[]
}

// --- 2. PRODUCTS (INVENTORY) ---
model Product {
  id          Int     @id @default(autoincrement())
  name        String
  // category    Category
  description String?
  isRentable  Boolean @default(true)
  image       String? // Product image URL

  // Pricing Strategy 
  priceHourly Decimal? @default(0)

  // Inventory Management
  totalStock Int @default(1)

  // Admin approval for vendor-submitted products
  adminApproved Boolean @default(false)

  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id])

  // Who owns this product? (Vendor)
  vendorId Int
  vendor   User @relation(fields: [vendorId], references: [id])

  // Relations
  orderItems OrderItem[]
}

// --- 3. ORDERS (SIMPLIFIED MVP) ---
// All states handled through Order status: QUOTATION -> SALE_ORDER -> SALE_ORDER_CONFIRMED -> INVOICED
enum OrderStatus {
  QUOTATION // Initial quote/draft (like cart)
  SALE_ORDER // Customer submitted order
  SALE_ORDER_CONFIRMED // Vendor confirmed order
  INVOICED // Invoice generated
  CANCELLED // Order cancelled
}

// Delivery method for order fulfillment
enum DeliveryMethod {
  COD
  PICKUP
}

// Current delivery status for fulfillment tracking
enum DeliveryStatus {
  PENDING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  IN_TRANSIT
  DELIVERED
}

model Order {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  status      OrderStatus @default(QUOTATION)
  deliveryStatus DeliveryStatus @default(PENDING)
  totalAmount Decimal?
  deliveryMethod DeliveryMethod?
  shippingAddress String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items   OrderItem[]
  invoice Invoice?
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  order     Order   @relation(fields: [orderId], references: [id])
  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity Int
  price    Decimal? // Calculated price for this item (hours * hourlyRate * quantity)

  // Dates are locked here for reservation logic [cite: 65]
  startDate DateTime
  endDate   DateTime
}

// --- 4. INVOICING ---
// Generated when order status is INVOICED
enum PaymentStatus {
  UNPAID
  PAID
  PARTIAL
}

model Invoice {
  id      Int   @id @default(autoincrement())
  orderId Int   @unique
  order   Order @relation(fields: [orderId], references: [id])

  userId Int
  user   User @relation(fields: [userId], references: [id])

  amountTotal Decimal
  amountPaid  Decimal       @default(0)
  status      PaymentStatus @default(UNPAID)

  pdfUrl   String? // For storing the generated PDF link
  issuedAt DateTime @default(now())
}
